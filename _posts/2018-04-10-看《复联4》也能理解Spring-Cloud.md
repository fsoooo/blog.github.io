---
layout: post
catalog: true
tags:
  - SpringCloud
  - 漫威
---
>文章来源：【[博客园作者：丶Pz](https://www.cnblogs.com/panzi/p/10681719.html)】

《复仇者联盟 4》将于 4 月 24 号上映，漫威迷们是不是迫不及待了？

![img](http://upload-images.jianshu.io/upload_images/6943526-4441704da7025515?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

**不过我在想一个问题：**假如《复联 4》是一个微服务，那么电影院就是一个应用。在这个微服务如此火爆的前提下，影院如何做好管理呢？

我们以此为背景，一起来趣谈 Spring Cloud 的工作原理！

### 影院开张

老王开了一家影院，刚开始影院规模很小，只有一个售票员小李。老王将《复联 4》即将上映的广告打出去之后，来咨询的人络绎不绝。

**这下小李不干了，说道：**老板，这么多人咨询已经打乱了我的正常工作了，影院这么多电影，我哪记得住它们什么时候上映啊。

**老王因此犯了愁，****小李又说：**老板，我给你引荐一个人吧，他们公司专门做这个业务的，他叫 **Eureka**。

![img](http://upload-images.jianshu.io/upload_images/6943526-f10de752c70ed3eb?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

服务注册和发现：电影的上映和下架

**Eureka** 来了之后，首先在影院装了一个大显示屏幕。老板告诉 **Eureka**：我们要准备上映《复联 4》了。

于是 **Eureka** 便把《复联 4》上线了。显示屏幕展示着最近上线的电影。这样，来电影院看电影的观众们就不用在咨询售票员了。

显示屏幕如下：

![img](http://upload-images.jianshu.io/upload_images/6943526-3aaa3acfab724ce8?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

客户端负载均衡：观众去哪个厅观看电影？

小李开开心心的工作着，突然 8001 厅的扫地大妈不乐意了......

**赵大妈说：**小李你咋回事啊，怎么我这个厅的人这么多，8002 厅的人那么少，是要累死我啊。

**老板见了说道：**哎呀，赵大妈您别着急，您看我这不是帮你招了个人吗，以后保证刘大妈的工作量和您保持一致。

**小伙子：**赵大妈您好，我是 **Ribbon**。

**赵大妈：**这名字挺洋气啊，来，你告诉我，你想怎么解决这个问题？

小伙子 Ribbon 回答，这好说，下面几种方案，您看你想要哪一种呢？

*   **随机法：**售票员随机给用户发一张票，这张票可能是 8001 厅的，也可能是 8002 厅的。
*   **服务响应最快法：**咱们 IMAX 厅工作人员多，服务又好，又宽敞，尽量往那个厅分配。
*   **轮询法：**轮着售卖：8001、8002、8001、8002......
*   **哈希法：**听说大妈您觉得情侣在电影院亲亲我我不舒服，那咱们就按照男女，男的去 8001 厅，女的去 8002 厅。
*   **最少连接法：**哪个厅人少，就往哪个厅分配。

赵大妈您觉得上面几个方案您还满意吗？“满意，满意，哎呀，这个 Ribbon 小伙子真不错”，赵大妈说道。

于是在 **Eureka** 和 **Ribbon** 的合作下，电影院正常运行。

![img](http://upload-images.jianshu.io/upload_images/6943526-99c40a1628126830?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

熔断限流：影院有人闹事

你们老板呢？卖出去 5000 张票，电影院这么小只能坐 2000 人，剩下的人咋办？

是啊，退票，退票！隔壁厅也乱起来了，这么吵还让不让人看电影了？

这时电影院乱成一团，无法正常营业了。老板只好挂出牌子：暂停营业，办理退票。

**Ribbon** 跟垂头丧气的老板说：老板生意好是好事啊，我认识一个朋友或许可以帮你。说曹操，曹操到，王老板，你好，我是 **Hystrix**。

老王：你好，你好，那请问，你要如何帮助我呢？

*   **限流：**卖票的时候，要求客户排好队伍，不要争抢。上午的 200 张票已经卖完了，大家下午再来吧。
*   **熔断：**8001 厅突然着火了，不能售卖和观看了。对不起：《复联 4》延缓上映，敬请关注。其他影厅不受影响。

![img](http://upload-images.jianshu.io/upload_images/6943526-c6a01468716f17b4?imageMogr2/auto-orient/strip)

服务网关：一个检票员就可以

**老王对人事部说：**最近咱们又加了 5 个影厅，你在去招 5 个检票员过来。另外把 8001 的那个检票员辞了，他竟然私自让他的好朋友不买票就进去看。

**人事部：**老板，咱们放映厅多了，不能这么干了，我给你介绍一个人，他一个人就可以做好这个事情了。

**老王：**好，你看着办吧。

大家好，我是 **Zuul**，很抱歉因为我的到来，老板将你们都辞退了，这是老板让我给你们发的遣散费。来，一人一百块钱。众人骂骂咧咧的走了。

新官上任三把火：

*   **统一入口：**影厅入口设立检票处，不管看什么电影都从这个入口进。
*   **服务鉴权：**您这张票是假票，不能进入。
*   **服务路由：**您好，《复联 4》左边 8001 厅，《雷神 3》往前走 8005 厅。

总结

老板发言：老王电影院自成立以来，承蒙各位大神的帮助。

*   **Eureka：**负责管理电影上下架工作。（服务注册和发现）
*   **Ribbon：**负责管理电影票的分发工作 。(服务负载均衡)
*   **Hystrix：**负责突发情况的处理和管控。 (服务熔断，限流，隔离等)
*   **Zuul：**负责影票的查验和影厅的导航工作。（服务统一管理，鉴权，路由等）

![img](http://upload-images.jianshu.io/upload_images/6943526-38250a13def28ef1?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

以上内容有很多理解不到位的地方或者比喻不太对的地方，还请谅解。权当一乐。最后祝大家观影愉快！
